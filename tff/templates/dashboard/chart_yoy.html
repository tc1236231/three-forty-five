{% extends "dashboard/base.html" %}
{% block extra_head_scripts %}
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/modules/export-data.js"></script>
  <link href="{{ url_for('static', filename='highcharts-data-table.css') }}" rel="stylesheet" />
{% endblock %}

{% block subtitle %}Year Over Year Attendance Dashboard{% endblock %}

{% block main %}
  <div class="row">
    <div class="col-2 my-auto">
      <label for="siteSelector">Please select a site:</label>
    </div>
    <div class="col-4 my-auto">
      <select class="form-control site-select" id="siteSelector">
      </select>
    </div>
  </div>
    <div class="row my-2">
        <div class="col-2 my-auto">
            <label for="siteSelector">Please select a category:</label>
        </div>
        <div class="col-4 my-auto">
            <select class="form-control category-select" id="categorySelector">
            </select>
        </div>
    </div>

    {% include "dashboard/components/userguide.html" %}

  <div class="p-1">
      <div id="chart" class="col-12" style="height: 550px;"></div>
  </div>

  <script>
   const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug',
                   'Sep', 'Oct', 'Nov', 'Dec', ];


   var visitData = {};
   var siteTotals = {};

   var chart = Highcharts.chart('chart', {
       chart: {
           type: 'spline'
       },
       title: {
           text: 'Year Over Year Attendance'
       },
       xAxis: {
           type: 'category',
           categories: ['Jul', 'Aug',
                   'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', ],
           title: {
               text: 'Month'
           }
       },
       tooltip: {
           shared:true,
           crosshairs:true
       },
       exporting: {
           showTable: true,
           csv:{
               itemDelimiter: ';'
           },
       }
   });
   chart.showLoading('<div class="my-auto"><img src="{{ url_for('static', filename='assets/img/Loading_icon.gif') }}"><h3>Loading Data...</h3></div');


   function readVisitData(rawVisitData) {
       visitData = {};
       let allSitesData = {};
       visitData['ALL SITES'] = allSitesData;
       $.each(rawVisitData, (_, record) => {
           if (!visitData[record.site]) {
               visitData[record.site] = {};
           }
           let siteData = visitData[record.site];
           
           if (!siteData[record.category]) {
               siteData[record.category] = {};
           }
           if (!allSitesData[record.category]) {
               allSitesData[record.category] = {};
           }
           let allSitesCategoryData = allSitesData[record.category];
           let categoryData = siteData[record.category];
           let data_date = new Date(record.date);

           let fy = data_date.getUTCFullYear() + (data_date.getUTCMonth() >= 6);
           if (!categoryData[fy]) {
               categoryData[fy] = [];
           }
           if (!allSitesCategoryData[fy]) {
               allSitesCategoryData[fy] = [];
           }
           let allSitesYearData = allSitesCategoryData[fy];
           let currentMonth = MONTHS[data_date.getUTCMonth()];
           let allSitesEntry = allSitesYearData.find(element => element[0] === currentMonth);
           if (allSitesEntry) {
               allSitesEntry[1] += record.count;
           } else {
               allSitesYearData.push([currentMonth, record.count]);
           }

           let yearData = categoryData[fy];
           
           yearData.push([currentMonth, record.count]);
       });
   }

   function addSiteTotals() {
       $.each(visitData, (siteName, siteData) => {
           if (!siteData['Totals']) {
               siteData['Totals'] = {};
           }

           $.each(siteData, (categoryName, categoryData) => {
               if(categoryName !== "Totals")
               {
                   $.each(categoryData, (fy, fyData) => {
                       if (!siteData['Totals'][fy]) {
                           siteData['Totals'][fy] = [];
                       }
                       $.each(fyData, (i, record) => {
                           if (!siteData['Totals'][fy][i]) {
                               siteData['Totals'][fy][i] = [record[0], 0];
                           }

                           siteData['Totals'][fy][i][1] += record[1];
                       });
                   });
               }
           });
       });
   }
   
   function initSiteSelect() {
       let siteSelect = $('.site-select');

       $.each(visitData, site => {
           let option = $('<option/>')
               .attr({value: site})
               .html(site)

           siteSelect.append(option)
       });

       siteSelect.change(() => {
           const site = getSiteSelection();

           const validCategory = $.inArray(getCategorySelection(),
                                           Object.keys(visitData[site]))
           if (!validCategory)  {
               initCategorySelect(site);
           }
           
           renderChart();
       });
   }

   function getSiteSelection() {
       return $('.site-select option:selected').val();
   }

   function initCategorySelect() {
       const site = getSiteSelection();
       const categorySelect = $('.category-select');

       categorySelect.empty()
       
       $.each(visitData[site], category => {
           let option = $('<option/>')
               .attr({value: category})
               .html(category);

           if (category === 'Totals') {
               categorySelect.prepend(option.prop('selected', true));
           } else {
               categorySelect.append(option);
           }
       });

       categorySelect.change(renderChart);
   }

   function getCategorySelection() {
       return $('.category-select option:selected').val();
   }

   function renderChart() {
       const site = getSiteSelection();
       const category = getCategorySelection();
       
       while(chart.series.length > 0) {
           chart.series[0].remove(true);
       }
       
       $.each(visitData[site][category], (year, data) => {
           chart.addSeries({
               name: "FY"+year,
               data: data
           });
       })

       chart.setSubtitle({
           text: site + ' - ' + category
       });
   }
   
   // Kick things off
   $.getJSON("{{ url_for('chart.attendance', mode="monthly") }}", rawVisitData => {
       readVisitData(rawVisitData);
       addSiteTotals();
       initSiteSelect();
       initCategorySelect();
       renderChart();
       chart.hideLoading();
   });
   


  </script>
{% endblock %}
