{% extends "dashboard/base.html" %}

{% block extra_head_scripts %}
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/modules/export-data.js"></script>
  <link href="{{ url_for('static', filename='highcharts-data-table.css') }}" rel="stylesheet" />
{% endblock %}

{% block subtitle %}Attendance Dashboard{% endblock %}

{% block main %}
  <div class="row">
    <div class="col-2 my-auto">
      <label for="siteSelector">Please select a site:</label>
    </div>
    <div class="col-10 my-auto">
      <select class="form-control" id="siteSelector">
      </select>
    </div>
  </div>
    <div class="row">
    <div class="col-2 my-auto">
      <label for="siteSelector">Please select a view setting:</label>
    </div>
    <div class="col-5 my-auto">
      <select class="form-control" id="timeSelector">
          <option value="daily">Daily</option>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
          <option value="quarterly">Quarterly</option>
          <option value="yearly">Yearly</option>
      </select>
    </div>
    <div class="col-5 my-auto">
      <select class="form-control" id="viewSelector">
          <option value="line">Line View</option>
          <option value="column">Column View</option>
          <option value="spline">Spline View</option>
      </select>
    </div>
  </div>
    <div class="row">
        <h3 class="col-4 badge badge-info text-wrap mx-auto my-3 p-2" style="font-size: 1em">
            A detailed explanation on attendance categories can be found <a target="_blank" href="https://docs.google.com/document/d/1z1zADs98XaGECbF1QWoJpUyMhbu-q_fWmQAYuzLqZDk/edit?usp=sharing">here</a>
        </h3>
    </div>
  <div class="p-1">
      <div id="chart" class="col-12" style="height: 550px;"></div>
  </div>

  <script>
   const median = arr => {
       const mid = Math.floor(arr.length / 2),
             nums = [...arr].sort((a, b) => a - b);
       return arr.length % 2 !== 0 ? nums[mid] : (nums[mid - 1] + nums[mid]) / 2;
   };
   var chart = undefined;
   var sites = [];
   var rawData = {};
   var fullData = {};
   var notTrigger = false;

   function viewAll()
   {
       chart.showLoading();
       let maxTime = 0;
       let siteData = {};
       let totalData = {};
       let medianData = {};
       $.each(fullData, function (name, dataEntry) {
           if(!siteData[name])
           {
               siteData[name] = [];
           }
           let sumData = {};
           $.each(dataEntry, function(key, val)
           {
               let entryDateTime = new Date(val.date).getTime();
               if(!sumData[entryDateTime])
               {
                   sumData[entryDateTime] = val.count;
               }
               else
               {
                   sumData[entryDateTime] += val.count;
               }
               if(entryDateTime > maxTime)
                   maxTime = entryDateTime;
           });
           $.each(sumData, function(time, count) {
               siteData[name].push([parseInt(time),count]);
               if(!totalData[time])
               {
                   totalData[time] = count;
                   medianData[time] = [];
               }
               else
               {
                   totalData[time] += count;
               }
               medianData[time].push(count);
           });
       });

       let numSites = 0;
       $.each(siteData, function (name, dataEntry) {
           dataEntry.sort(function (a, b) {
               return a[0] - b[0]
           });
           let dashedStartingTime = Number.MAX_SAFE_INTEGER;
           if(dataEntry.length >= 2 && maxTime === dataEntry[dataEntry.length - 1][0])
           {
               dashedStartingTime = dataEntry[dataEntry.length - 2][0]
           }
           chart.addSeries({
               name: name,
               data: dataEntry,
               zoneAxis: 'x',
               zones: [{
                   value: dashedStartingTime
               }, {
                   dashStyle: 'dot'
               }],
               events: {
                   show: function () {
                       setTimeout(function(){
                           notTrigger = true;
                           $(chart.series).each(function(index, series){
                               if(series.name === 'Overall Total')
                                   this.setVisible(false, false);
                           });
                           chart.redraw();
                           notTrigger = false;
                       }, 1);
                   }
               }
           }, false);
           numSites++;
       });

       let totalDataPoints = [];
       $.each(totalData, function (time, count) {
           totalDataPoints.push([parseInt(time),count]);
       });
       totalDataPoints.sort(function (a, b) {
           return a[0] - b[0]
       });

       let medianDataPoints = [];
       $.each(medianData, function (time, count_array) {
           medianDataPoints.push([parseInt(time),median(count_array)]);
       });
       medianDataPoints.sort(function (a, b) {
           return a[0] - b[0]
       });

       let dashedStartingTime = Number.MAX_SAFE_INTEGER;
       if(totalDataPoints.length >= 2 && maxTime === totalDataPoints[totalDataPoints.length - 1][0])
       {
           dashedStartingTime = totalDataPoints[totalDataPoints.length - 2][0]
       }

       let avgDataPoints = JSON.parse(JSON.stringify(totalDataPoints));
       $.each(avgDataPoints, function(index, array){
           array[1] = parseFloat((array[1] / numSites).toFixed(2));
       });

       chart.addSeries({
           name: 'Median',
           data: medianDataPoints,
           lineWidth: 5,
           zoneAxis: 'x',
           zones: [{
               value: dashedStartingTime
           }, {
               dashStyle: 'dot'
           }],
           events: {
               show: function () {
                   setTimeout(function(){
                       notTrigger = true;
                       $(chart.series).each(function(index, series){
                           if(series.name === 'Overall Total')
                               this.setVisible(false, false);
                       });
                       chart.redraw();
                       notTrigger = false;
                   }, 1);
               }
           }
       }, false);

       chart.addSeries({
           name: 'Average',
           data: avgDataPoints,
           lineWidth: 5,
           zoneAxis: 'x',
           zones: [{
               value: dashedStartingTime
           }, {
               dashStyle: 'dot'
           }],
           events: {
               show: function () {
                   setTimeout(function(){
                       notTrigger = true;
                       $(chart.series).each(function(index, series){
                           if(series.name === 'Overall Total')
                               this.setVisible(false, false);
                       });
                       chart.redraw();
                       notTrigger = false;
                   }, 1);
               }
           }
       }, false);

       chart.addSeries({
           name: 'Overall Total',
           data: totalDataPoints,
           color: 'black',
           index: -1,
           zoneAxis: 'x',
           zones: [{
               value: dashedStartingTime
           }, {
               dashStyle: 'dot'
           }],
           events: {
               hide: function () {
                   if(notTrigger)
                       return;
                   setTimeout(function(){
                       $(chart.series).each(function(index, series){
                           if(series.name !== 'Overall Total')
                               this.setVisible(true, true);
                       });
                       chart.redraw();
                   }, 1);
               },
               show: function () {
                   setTimeout(function(){
                       $(chart.series).each(function(index, series){
                           if(series.name !== 'Overall Total')
                               this.setVisible(false, false);
                       });
                       chart.redraw();
                   }, 1);
               }
           }
       }, false).setVisible(true,true);

       chart.setSubtitle({
           text: 'All ' + numSites + ' Sites Data'
       });

       chart.redraw();
       chart.hideLoading();
   }

   function viewSite(name)
   {
       while(chart.series.length > 0)
           chart.series[0].remove(true);

       if(name === "ALL")
           return viewAll();

       chart.showLoading();
       let maxTime = 0;
       let categoryData = {};
       let sumData = {};
       $.each(fullData[name], function (index, dataEntry) {
           let category = dataEntry.category;
           if(!categoryData[category])
           {
               categoryData[category] = [];
           }
           let entryDateTime = new Date(dataEntry.date).getTime();
           if(!sumData[entryDateTime])
           {
               sumData[entryDateTime] = dataEntry.count;
           }
           else
           {
               sumData[entryDateTime] += dataEntry.count;
           }
           if(entryDateTime > maxTime)
               maxTime = entryDateTime;
           categoryData[category].push([entryDateTime, parseFloat((dataEntry.count).toFixed(2))]);
       });

       let sumDataPoints = [];
       $.each(sumData, function (entryDateTime, count) {
           sumDataPoints.push([parseInt(entryDateTime),count]);
       });
       sumDataPoints.sort(function (a, b) {
           return a[0] - b[0]
       });

       $.each(categoryData, function (category, dataEntry) {
           dataEntry.sort(function (a, b) {
               return a[0] - b[0]
           });
           let dashedStartingTime = Number.MAX_SAFE_INTEGER;
           if(dataEntry.length >= 2 && maxTime === dataEntry[dataEntry.length - 1][0])
           {
               dashedStartingTime = dataEntry[dataEntry.length - 2][0]
           }
           chart.addSeries({
               name: category,
               data: dataEntry,
               zoneAxis: 'x',
               zones: [{
                   value: dashedStartingTime
               }, {
                   dashStyle: 'dot'
               }],
               events: {
                   show: function () {
                       setTimeout(function(){
                           notTrigger = true;
                           $(chart.series).each(function(index, series){
                               if(series.name === 'Overall Total')
                                   this.setVisible(false, false);
                           });
                           chart.redraw();
                           notTrigger = false;
                       }, 1);
                   }
               }
           }, false);
       });

       let dashedStartingTime = Number.MAX_SAFE_INTEGER;
       if(sumDataPoints.length >= 2 && maxTime === sumDataPoints[sumDataPoints.length - 1][0])
       {
           dashedStartingTime = sumDataPoints[sumDataPoints.length - 2][0]
       }

       chart.addSeries({
           name: 'Overall Total',
           data: sumDataPoints,
           color: 'black',
           index: -1,
           zoneAxis: 'x',
           zones: [{
               value: dashedStartingTime
           }, {
               dashStyle: 'dot'
           }],
           events: {
               hide: function () {
                   if(notTrigger)
                       return;
                   setTimeout(function(){
                       $(chart.series).each(function(index, series){
                           if(series.name !== 'Overall Total')
                               this.setVisible(true, true);
                       });
                       chart.redraw();
                   }, 1);
               },
               show: function () {
                   setTimeout(function(){
                       $(chart.series).each(function(index, series){
                           if(series.name !== 'Overall Total')
                               this.setVisible(false, false);
                       });
                       chart.redraw();
                   }, 1);
               }
           }
       }, false).setVisible(true,true);

       chart.setSubtitle({
           text: name + ' - ' + fullData[name].length + ' Data Entries'
       });

       chart.redraw();
       chart.hideLoading();
   }

   function viewChart(timeMode, viewMode, reloadData=true)
   {
       if(chart) {
           chart.destroy();
           $('.highcharts-data-table').remove();
       }

       $("#siteSelector").html('');

       chartCustomConfig = {timeFormat: '%b %Y', xAxisTitle: 'Time', viewType: viewMode};
       switch (timeMode) {
           case 'daily':
               chartCustomConfig.timeFormat = '%d %b %Y';
               break;
           case 'weekly':
               chartCustomConfig.timeFormat = '%d %b %Y';
               chartCustomConfig.xAxisTitle = 'Time (Start Date of the Week)';
               break;
           case 'monthly':
              chartCustomConfig.timeFormat = '%b %Y';
              break;
           case 'quarterly':
              chartCustomConfig.timeFormat = 'Q%q FY%fy';
              chartCustomConfig.xAxisTitle = 'Time (Fiscal Quarter)';
              break;
           case 'yearly':
              chartCustomConfig.timeFormat = 'FY%fy';
              chartCustomConfig.xAxisTitle = 'Time (Fiscal Year)';
              break;
       }

       createChart(chartCustomConfig);
       chart.showLoading();

       if(!reloadData && Object.keys(rawData).length !== 0)
       {
           addData(rawData);
       }
       else
       {
           $.getJSON("{{ url_for('chart.attendance', mode="") }}" + timeMode, addData);
       }
   }

   function addData(data) {
       rawData = data;
       fullData = {};

       var r = $('<option/>').attr({
           value: 'ALL',
       }).html("ALL SITES");
       $("#siteSelector").append(r);

       $.each(data, function (index, val) {
           let site = val.site;
           if(!fullData[site])
           {
               sites.push(site);
               fullData[site] = [];
               var r = $('<option/>').attr({
                   value: site,
               }).html(site);
               $("#siteSelector").append(r);
           }
           fullData[val.site].push(val);
       });

       viewSite('ALL');
   }

   viewChart('daily', 'line');

   function createChart(config) {
        Highcharts.dateFormats = {
            q: function (timestamp) {
                var date = new Date(timestamp),
                quarter = (Math.floor(date.getUTCMonth() / 3) + 1) - 2;
                if(quarter <= 0)
                    quarter += 4;
                return quarter;
            },
            fy: function (timestamp) {
                var date = new Date(timestamp);
                return date.getUTCFullYear() + 1;
            },
        };

       chart = Highcharts.chart('chart', {
           chart: {
               zoomType: 'x',
               type: config.viewType,
           },

           title: {
               text: 'MNHS Attendance Chart'
           },

           subtitle: {
               text: 'Loading'
           },

           yAxis: {
               title: {
                   text: 'Count'
               }
           },
           plotOptions: {
               series: {
                   marker: {
                       enabled: false
                   }
               }
           },

           tooltip: {
               shared:true,
               crosshairs:true,
               valueDecimals: 0,
               xDateFormat: config.timeFormat,
           },

           xAxis: {
               type: 'datetime',
               title: {
                   text: config.xAxisTitle
               },
           },

           legend: {
               align: 'center',
               borderWidth: 0
           },

           series: [],

           exporting: {
               showTable: true,
               csv:{
                   dateFormat: config.timeFormat,
                   itemDelimiter: ';'
               },
           },
       });
   }

   $("#siteSelector").change(function(){
       viewSite(this.value);
   });
   $("#viewSelector").change(function(){
       let timeMode = $('#timeSelector').val();
       viewChart(timeMode, this.value, false);
   });
   $("#timeSelector").change(function(){
       let viewMode = $('#viewSelector').val();
       viewChart(this.value, viewMode);
   });
  </script>
{% endblock %}